<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oceanbooth Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Poppins:wght@400;500;600;700&family=Caveat:wght@400..700&family=Sail&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <style>
      .sail {
        font-family: "Sail", system-ui;
        font-weight: 400;
        font-style: normal;
      }
      .caveat {
        font-family: "Caveat", cursive;
        font-weight: 400;
        font-style: normal;
      }
    </style>
    <style>
      .polaroid-strip {
        position: relative;
        width: 280px; /* Ukuran sedikit diperbesar dari 260px */
        padding: 16px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        background: #f8c8ec;
        border-radius: 4px;
        /* Hapus rotasi -2deg di mobile agar tidak memakan ruang lebar, aktifkan di desktop saja */
      }

      @media (min-width: 1024px) {
        .polaroid-strip {
          transform: rotate(-2deg);
        }
      }

      .polaroid {
        background: #f5f5f5;
        padding-top: 13px;
        padding-left: 13px;
        padding-right: 13px;
      }

      .polaroid-last {
        padding-bottom: 30px;
      }

      .polaroid img {
        width: 100%;
        height: 160px; /* Diperbesar sedikit dari 150px */
        object-fit: cover;
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#f5e8d3] overflow-x-hidden font-['Poppins']">
    <nav class="flex items-center justify-between border-b border-black/5 bg-white/20 backdrop-blur-md sticky top-0 z-50">
      <div class="sail px-6 py-3 text-2xl font-medium">
        <h1 class="text-[#194e5d]">Blububooth!</h1>
      </div>
    </nav>

    <div class="w-full max-w-screen-xl mx-auto px-4 py-8">
      <div class="flex flex-col lg:flex-row items-center lg:items-start justify-center gap-10 lg:gap-20">
        
        <div class="flex flex-col items-center w-full lg:w-auto">
          <div id="stripPreview" class="polaroid-strip origin-top transform scale-[1.05] sm:scale-110 lg:scale-100 transition-transform duration-300">
            <div id="photoLayer"></div>
            <div id="stickerLayer"></div>
          </div>
          <p class="mt-8 text-sm text-gray-500 font-medium italic lg:hidden">Preview Tampilan</p>
        </div>

        <div class="w-full max-w-[450px] space-y-8 bg-white/40 p-6 sm:p-8 rounded-[2rem] backdrop-blur-md shadow-xl border border-white/50">
          
          <div>
            <h2 class="font-bold mb-4 text-[#194e5d] text-lg flex items-center gap-2">
              <i class="fa-solid fa-palette"></i> Photostrip Color
            </h2>
            <div class="grid grid-cols-5 sm:grid-cols-7 gap-3">
              <button onclick="setStripColor('linear-gradient(to bottom, #194e5d, #2c7b8b, #e2bfa1)')" class="w-10 h-10 rounded-full bg-gradient-to-b from-[#194e5d] via-[#2c7b8b] to-[#e2bfa1] shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('linear-gradient(to bottom, #654ea3, #eaafc8)')" class="w-10 h-10 rounded-full bg-gradient-to-b from-[#654ea3] to-[#eaafc8] shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('linear-gradient(to bottom, #0F2027, #203A43, #2C5364)')" class="w-10 h-10 rounded-full bg-gradient-to-b from-[#0F2027] via-[#203A43] to-[#2C5364] shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('linear-gradient(to bottom, #f4c4f3, #fc67fa)')" class="w-10 h-10 rounded-full bg-gradient-to-b from-[#f4c4f3] to-[#fc67fa] shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('linear-gradient(to bottom, #373B44, #4286f4)')" class="w-10 h-10 rounded-full bg-gradient-to-b from-[#373B44] to-[#4286f4] shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('#000000')" class="w-10 h-10 rounded-full bg-black shadow-md border-2 border-white hover:scale-110 transition"></button>
              <button onclick="setStripColor('#e8e1d8')" class="w-10 h-10 rounded-full bg-[#e8e1d8] shadow-md border-2 border-white hover:scale-110 transition"></button>
            </div>
            
            <div class="mt-5">
               <label class="text-sm font-semibold text-gray-700 mb-2 block">Custom Frame Color:</label>
               <input type="color" id="frameColorPicker" value="#f5f5f5" class="w-full h-10 rounded-lg cursor-pointer bg-white p-1">
            </div>
          </div>

          <div>
            <h2 class="font-bold mb-4 text-[#194e5d] text-lg flex items-center gap-2">
              <i class="fa-solid fa-face-smile"></i> Sea Stickers
            </h2>
            <div class="flex flex-wrap gap-4 items-center bg-white/50 p-4 rounded-2xl">
              <img src="./assets/stiker/bare-bears/bear8.png" class="w-12 h-12 cursor-pointer hover:scale-125 transition-transform drop-shadow" onclick="applyStickerTemplate('whiteBear')" />
              <img src="./assets/stiker/bare-bears/panda5.png" class="w-12 h-12 cursor-pointer hover:scale-125 transition-transform drop-shadow" onclick="applyStickerTemplate('panda')" />
              <img src="./assets/stiker/bare-bears/grizzly7.png" class="w-12 h-12 cursor-pointer hover:scale-125 transition-transform drop-shadow" onclick="applyStickerTemplate('grizzly')" />
              <button class="w-12 h-12 flex items-center justify-center bg-red-100 text-red-500 rounded-xl hover:bg-red-200 transition" onclick="clearStiker()">
                <i class="fa-solid fa-trash-can text-xl"></i>
              </button>
            </div>
          </div>

          <div>
            <h2 class="font-bold mb-4 text-[#194e5d] text-lg flex items-center gap-2">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Filters
            </h2>
            <div class="flex flex-wrap gap-2">
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">normal</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">vintage</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">warm</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">cool</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">bw</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">retro</button>
              <button class="filter-btn px-4 py-2 uppercase tracking-tighter font-bold">soft</button>
            </div>
          </div>

          <div class="flex items-center gap-3 bg-white/30 p-4 rounded-xl">
             <input type="checkbox" id="dateToggle" checked class="w-5 h-5 accent-[#ffb703]">
             <label for="dateToggle" class="text-sm font-bold text-gray-700">Tampilkan Tanggal (Date Stamp)</label>
          </div>

          <div class="space-y-4 pt-4 border-t border-black/5">
            <button id="downloadBtn" class="w-full py-4 rounded-2xl bg-[#ffb703] hover:bg-[#fb8500] text-[#194e5d] text-lg font-black shadow-lg shadow-orange-200 active:scale-95 transition-all">
              <i class="fa-solid fa-cloud-arrow-down mr-2"></i> DOWNLOAD PHOTOSTRIP
            </button>
            <button onclick="retake()" class="w-full py-4 rounded-2xl bg-white/80 hover:bg-white text-gray-700 text-lg font-bold shadow-sm active:scale-95 transition-all border border-gray-200">
              <i class="fa-solid fa-camera-rotate mr-2"></i> RETAKE PHOTOS
            </button>
          </div>

          <div class="flex justify-center pt-2">
            <a href="index.html" class="text-[#e76f51] font-bold flex items-center gap-2 hover:gap-4 transition-all">
              <i class="fa-solid fa-arrow-left"></i> Kembali ke Menu Utama
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="pb-12 pt-6">
      <div class="caveat flex flex-col items-center justify-center opacity-40">
        <h1 class="text-xl italic">→ Made with hnifn.png ←</h1>
      </div>
    </div>

    <script>
      function drawPhotoToCanvas(ctx, img, x, y, w, h) {
        const imgRatio = img.width / img.height;
        const canvasRatio = w / h;
        let sx, sy, sw, sh;
        if (imgRatio > canvasRatio) {
          sw = img.height * canvasRatio;
          sh = img.height;
          sx = (img.width - sw) / 2;
          sy = 0;
        } else {
          sw = img.width;
          sh = img.width / canvasRatio;
          sx = 0;
          sy = (img.height - sh) / 2;
        }
        ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
      }
    </script>

    <script>
      const photoLayer = document.getElementById("photoLayer");
      const stickerLayer = document.getElementById("stickerLayer");
      const frameColorPicker = document.getElementById("frameColorPicker");

      frameColorPicker.addEventListener("input", (e) => {
        setPolaroidColor(e.target.value);
      });

      const photos = JSON.parse(localStorage.getItem("oceanboothPhotos")) || [];
      if (photos.length !== 3) {
        alert("Photo data not found");
        location.href = "index.html";
      }
      
      const stripPreview = document.getElementById("stripPreview");
      const downloadBtn = document.getElementById("downloadBtn");

      let activeFilter = "normal";
      let stripColor = "linear-gradient(to bottom, #194e5d, #2c7b8b, #e2bfa1)";
      let FrameColor = "#f5f5f5";

      const filters = {
        normal: "none",
        vintage: "sepia(0.35) contrast(0.9) brightness(1.1) saturate(1.1)",  
        warm: "saturate(1.5) sepia(0.2) brightness(1.05) contrast(1.1)",
        cool: "hue-rotate(180deg) saturate(0.8) brightness(1.05) contrast(1.1) opacity(0.9) hue-rotate(-190deg)", 
        bw: "grayscale(1) contrast(1.3) brightness(1.1)",
        retro: "contrast(1.2) saturate(1.3) sepia(0.25) hue-rotate(-10deg) brightness(0.95)",
        soft: "brightness(1.1) saturate(1.1) contrast(0.9) blur(0.2px)"
      };

      const today = new Date();
      const formattedDate = today.toLocaleDateString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
      });

      let showDate = true;

      function renderPreview() {
        photoLayer.innerHTML = "";
        stripPreview.style.background = stripColor;

        photos.forEach((src, index) => {
          const frame = document.createElement("div");
          frame.className = "polaroid";

          if (index === photos.length - 1) {
            frame.classList.add("polaroid-last");
          }

          frame.style.background = FrameColor;

          const img = document.createElement("img");
          img.src = src;
          img.style.filter = filters[activeFilter];

          frame.appendChild(img);

          if (index === photos.length - 1 && showDate) {
            const dateEl = document.createElement("div");
            dateEl.className = "mt-3 text-center text-[10px] tracking-widest text-gray-500 uppercase font-mono";
            dateEl.textContent = formattedDate;
            frame.appendChild(dateEl);
          }

          photoLayer.appendChild(frame);
        });
      }

      function setStripColor(color) {
        stripColor = color;
        renderPreview();
      }

      function setPolaroidColor(color) {
        FrameColor = color;
        renderPreview();
      }

      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.classList.add("px-3", "py-1.5", "bg-[#194e5d]", "text-white", "rounded-xl", "text-[10px]", "transition-all");

        btn.onclick = () => {
          activeFilter = btn.textContent.toLowerCase().trim();
          document.querySelectorAll(".filter-btn").forEach((b) => {
            b.classList.remove("bg-[#ffb703]", "text-[#194e5d]", "ring-2", "ring-[#ffb703]");
            b.classList.add("bg-[#194e5d]", "text-white");
          });
          btn.classList.remove("bg-[#194e5d]", "text-white");
          btn.classList.add("bg-[#ffb703]", "text-[#194e5d]", "ring-2", "ring-[#ffb703]");
          renderPreview();
        };
      });

      const stickerLayouts = {
        whiteBear: [
          { x: 10, y: 20, size: 50, src: "./assets/stiker/bare-bears/bear5.png" },
          { x: 215, y: 80, size: 50, src: "./assets/stiker/bare-bears/bear6.png" },
          { x: 0, y: 150, size: 70, src: "./assets/stiker/bare-bears/bear7.png" },
          { x: 205, y: 215, size: 60, src: "./assets/stiker/bare-bears/bear10.png" },
          { x: 100, y: 130, size: 70, src: "./assets/stiker/bare-bears/bear9.png" },
          { x: 180, y: 295, size: 60, src: "./assets/stiker/bare-bears/bear8.png" },
          { x: 13, y: 310, size: 50, src: "./assets/stiker/bare-bears/bear11.png" },
          { x: 10, y: 500, size: 50, src: "./assets/stiker/bare-bears/bear12.png" },
          { x: 200, y: 500, size: 50, src: "./assets/stiker/bare-bears/bear13.png" },
        ],
        panda: [
          { x: 10, y: 14, size: 60, src: "./assets/stiker/bare-bears/panda2.png" },
          { x: 200, y: 15, size: 80, src: "./assets/stiker/bare-bears/panda6.png" },
          { x: 5, y: 130, size: 70, src: "./assets/stiker/bare-bears/panda3.png" },
          { x: 200, y: 140, size: 50, src: "./assets/stiker/bare-bears/panda5.png" },
          { x: 180, y: 295, size: 70, src: "./assets/stiker/bare-bears/panda4.png" },
          { x: 0, y: 300, size: 80, src: "./assets/stiker/bare-bears/panda7.png" },
          { x: 10, y: 500, size: 60, src: "./assets/stiker/bare-bears/panda8.png" },
          { x: 180, y: 500, size: 70, src: "./assets/stiker/bare-bears/panda9.png" },
        ],
        grizzly: [
          { x: 10, y: 14, size: 40, src: "./assets/stiker/bare-bears/grizzly9.png" },
          { x: 190, y: 120, size: 70, src: "./assets/stiker/bare-bears/grizzly2.png" },
          { x: 5, y: 130, size: 60, src: "./assets/stiker/bare-bears/grizzly3.png" },
          { x: 180, y: 290, size: 50, src: "./assets/stiker/bare-bears/grizzly4.png" },
          { x: 20, y: 280, size: 45, src: "./assets/stiker/bare-bears/grizzly6.png" },
          { x: 15, y: 490, size: 60, src: "./assets/stiker/bare-bears/grizzly7.png" },
          { x: 190, y: 500, size: 40, src: "./assets/stiker/bare-bears/grizzly.png" },
        ],
      };

      function applyStickerTemplate(type) {
        stickerLayer.innerHTML = "";
        const layout = stickerLayouts[type];
        if (!layout) return;
        layout.forEach((pos) => {
          const sticker = document.createElement("img");
          sticker.src = pos.src;
          sticker.className = "auto-sticker absolute pointer-events-none drop-shadow-sm";
          sticker.style.width = pos.size + "px";
          sticker.style.left = pos.x + "px";
          sticker.style.top = pos.y + "px";
          stickerLayer.appendChild(sticker);
        });
      }

      function clearStiker() {
        stickerLayer.innerHTML = "";
      }

      document.getElementById("dateToggle").addEventListener("change", (e) => {
        showDate = e.target.checked;
        renderPreview();
      });

      function drawImageCover(ctx, img, x, y, w, h) {
        const imgRatio = img.width / img.height;
        const boxRatio = w / h;
        let sx, sy, sw, sh;
        if (imgRatio > boxRatio) {
          sw = img.height * boxRatio;
          sh = img.height;
          sx = (img.width - sw) / 2;
          sy = 0;
        } else {
          sw = img.width;
          sh = img.width / boxRatio;
          sx = 0;
          sy = (img.height - sh) / 2;
        }
        ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
      }

      downloadBtn.onclick = async () => {
        const originalText = downloadBtn.innerText;
        downloadBtn.innerText = "Processing...";
        downloadBtn.disabled = true;

        try {
          const SCALE = 4; 
          const CANVAS_W = 280 * SCALE;
          const PADDING = 16 * SCALE;
          const FRAME_INNER_PAD = 13 * SCALE;
          const PHOTO_W = (280 - 16 * 2 - 13 * 2) * SCALE;
          const PHOTO_H = 160 * SCALE;
          const DATE_SPACE = showDate ? 40 * SCALE : 10 * SCALE;
          const singleFrameH = FRAME_INNER_PAD + PHOTO_H + FRAME_INNER_PAD;
          const TOTAL_H = PADDING * 2 + (singleFrameH * 3) + DATE_SPACE;

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = CANVAS_W;
          canvas.height = TOTAL_H;

          if (stripColor.startsWith("linear-gradient")) {
            const colors = stripColor.match(/#[a-fA-F0-9]{6}/g);
            const grad = ctx.createLinearGradient(0, 0, 0, TOTAL_H);
            if (colors && colors.length > 1) {
              colors.forEach((col, idx) => grad.addColorStop(idx / (colors.length - 1), col));
              ctx.fillStyle = grad;
            } else {
              ctx.fillStyle = colors ? colors[0] : "#f8c8ec";
            }
          } else {
            ctx.fillStyle = stripColor;
          }
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          let currentY = PADDING;
          for (let i = 0; i < photos.length; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = photos[i];
            await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });

            const isLast = i === photos.length - 1;
            const currentFrameH = isLast ? singleFrameH + DATE_SPACE - 10 * SCALE : singleFrameH;

            ctx.filter = "none";
            ctx.fillStyle = FrameColor;
            ctx.fillRect(PADDING, currentY, CANVAS_W - PADDING * 2, currentFrameH);

            if (img.complete && img.naturalWidth !== 0) {
              ctx.filter = filters[activeFilter] || "none";
              drawImageCover(ctx, img, PADDING + FRAME_INNER_PAD, currentY + FRAME_INNER_PAD, CANVAS_W - (PADDING + FRAME_INNER_PAD) * 2, PHOTO_H);
            }

            if (isLast && showDate) {
              ctx.filter = "none";
              ctx.fillStyle = "#6B7280";
              ctx.font = `${10 * SCALE}px monospace`;
              ctx.textAlign = "center";
              ctx.fillText(formattedDate.toUpperCase(), canvas.width / 2, currentY + singleFrameH + 15 * SCALE);
            }
            currentY += singleFrameH;
          }

          const stickers = stickerLayer.querySelectorAll("img");
          for (const s of stickers) {
            const sImg = new Image();
            sImg.crossOrigin = "anonymous";
            sImg.src = s.src;
            await new Promise((resolve) => { sImg.onload = resolve; sImg.onerror = resolve; });
            if (sImg.complete && sImg.naturalWidth !== 0) {
              const x = parseFloat(s.style.left) * (280/280) * SCALE;
              const y = parseFloat(s.style.top) * SCALE;
              const size = parseFloat(s.style.width) * SCALE;
              ctx.filter = "none";
              ctx.drawImage(sImg, x, y, size, size);
            }
          }

          const link = document.createElement("a");
          link.download = `oceanbooth-${Date.now()}.png`;
          link.href = canvas.toDataURL("image/png", 1.0);
          link.click();
        } catch (err) {
          console.error(err);
          alert("Gagal mengunduh foto.");
        } finally {
          downloadBtn.innerText = originalText;
          downloadBtn.disabled = false;
        }
      };

      function retake() {
        localStorage.removeItem("oceanboothPhotos");
        location.href = "index.html";
      }

      renderPreview();
    </script>
  </body>
</html>